<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.lovetime.mapper.ChallengeRecordMapper">
    
    <resultMap type="ChallengeRecord" id="ChallengeRecordResult">
        <result property="id" column="id"/>
        <result property="taskId" column="task_id"/>
        <result property="userId" column="user_id"/>
        <result property="status" column="status"/>
        <result property="photoUrl" column="photo_url"/>
        <result property="note" column="note"/>
        <result property="isFavorited" column="is_favorited"/>
        <result property="completedAt" column="completed_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    
    <sql id="selectChallengeRecordVo">
        select id, task_id, user_id, status, photo_url, note, is_favorited, completed_at, created_at, updated_at from at_challenge_records
    </sql>
    
    <select id="selectChallengeRecordList" parameterType="ChallengeRecord" resultMap="ChallengeRecordResult">
        <include refid="selectChallengeRecordVo"/>
        <where>
            <if test="taskId != null "> and task_id = #{taskId}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="isFavorited != null "> and is_favorited = #{isFavorited}</if>
        </where>
        order by id desc
    </select>
    
    <select id="selectChallengeRecordByUserAndTask" parameterType="map" resultMap="ChallengeRecordResult">
        <include refid="selectChallengeRecordVo"/>
        where user_id = #{userId} and task_id = #{taskId}
    </select>
    
    <select id="selectChallengeRecordById" parameterType="Long" resultMap="ChallengeRecordResult">
        <include refid="selectChallengeRecordVo"/>
        where id = #{id}
    </select>
    
    <insert id="insertChallengeRecord" parameterType="ChallengeRecord" useGeneratedKeys="true" keyProperty="id">
        insert into at_challenge_records
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="taskId != null">task_id,</if>
            <if test="userId != null">user_id,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="photoUrl != null">photo_url,</if>
            <if test="note != null">note,</if>
            <if test="isFavorited != null">is_favorited,</if>
            <if test="completedAt != null">completed_at,</if>
            <if test="createdAt != null">created_at,</if>
            <if test="updatedAt != null">updated_at,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="taskId != null">#{taskId},</if>
            <if test="userId != null">#{userId},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="photoUrl != null">#{photoUrl},</if>
            <if test="note != null">#{note},</if>
            <if test="isFavorited != null">#{isFavorited},</if>
            <if test="completedAt != null">#{completedAt},</if>
            <if test="createdAt != null">#{createdAt},</if>
            <if test="updatedAt != null">#{updatedAt},</if>
        </trim>
    </insert>
    
    <update id="updateChallengeRecord" parameterType="ChallengeRecord">
        update at_challenge_records
        <set>
            <if test="taskId != null">task_id = #{taskId},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="photoUrl != null">photo_url = #{photoUrl},</if>
            <if test="note != null">note = #{note},</if>
            <if test="isFavorited != null">is_favorited = #{isFavorited},</if>
            <if test="completedAt != null">completed_at = #{completedAt},</if>
            <if test="createdAt != null">created_at = #{createdAt},</if>
            updated_at = #{updatedAt},
        </set>
        where id = #{id}
    </update>
    
    <delete id="deleteChallengeRecordById" parameterType="Long">
        delete from at_challenge_records where id = #{id}
    </delete>
    
    <delete id="deleteChallengeRecordByIds" parameterType="Long">
        delete from at_challenge_records where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <select id="countCompletedTasksByUserId" parameterType="map" resultType="int">
        select count(*) from at_challenge_records 
        where user_id = #{userId} and status = 'completed'
    </select>
    
    <select id="countFavoritedTasksByUserId" parameterType="map" resultType="int">
        select count(*) from at_challenge_records 
        where user_id = #{userId} and is_favorited = 1
    </select>
    
    <select id="countTotalTasksByUserId" parameterType="map" resultType="int">
        select count(*) from at_challenge_tasks t
        left join at_challenge_records r on t.id = r.task_id and r.user_id = #{userId}
        where t.is_active = 1
    </select>
</mapper>